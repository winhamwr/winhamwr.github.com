<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Pragmatic Django Performance</title>

  <meta name="viewport" content="width=device-width"/>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>
  <script type="text/javascript" src="./js/coffee-script.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/style.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
      setupPreso(false, './');
  });
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="title_slide/01_slide">
<h1>Pragmatic Django Performance: The 20% that matters</h1>

<ul>
<li>Performance matters</li>
<li>Mistakes to avoid</li>
<li>Smallest changes, largest impact</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental" ref="intro/01_outline">
<h1>hello</h1>

<ul>
<li>Wes Winham @weswinham, <a href="http://gplus.to/weswinham">gplus.to/weswinham</a></li>
<li>Responsible for product development at PolicyStat</li>
<li>~6 year old Django app, ~1 million monthly page views</li>
<li>Lots of lessons learned the hard way</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/1">
<h1>Performance Matters</h1></div>
</div><div class="slide" data-transition="none"><div class="content fullscreen center" ref="content/01_slide/2">
<p><img src="./file/content/performance_matters.jpg" width="668" height="234"/>

<br/>


<div class="photo-credits">
        photo: <a href="http://www.cloudreviews.com/blog/web-performance-optimization-part-1">
cloudreviews.com</a>
</div>


</p>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="content/01_slide/3">
<h1>The magic number now is now somewhere between 300 to 250ms</h1>

<h3>- Harry Schum, Speed specialist for MS</h3></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/4">
<h1>Study Results</h1>

<ul>
<li>Bing- 2s == 4.3% less revenue</li>
<li>Yahoo- 400ms == 5-9% less traffic</li>
<li>Google- 400ms == ~1% less searching</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/5">
<h1>But we're busy!</h1></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/6">
<h1>Not that busy</h1>

<ul>
<li>Many cheap/easy "optimizations"</li>
<li>Easy once you notice them</li>
<li>One-time improvements with big payoffs</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/7">
<h1>First rule of optimization:</h1></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/8">
<h1>No premature optimization</h1></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/9">
<h1>It affects to lots of developers</h1></div>
</div><div class="slide" data-transition="none"><div class="content fullscreen center" ref="content/01_slide/10">
<p><img src="./file/content/sad_guy.png" width="680" height="875"/>

<br/>


</p>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/11">
<h1>Choose obvious wins!</h1>

<ul>
<li>Don't add code complexity</li>
<li>Don't make things fragile</li>
<li>But you should be monitoring (New Relic)</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/12">
<h1>Advice by (bad) example</h1></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/13">
<h1>Anti-pattern 1: Ignore the front end</h1></div>
</div><div class="slide" data-transition="none"><div class="content fullscreen center" ref="content/01_slide/14">
<p><img src="./file/content/its_the_frontend.png" width="945" height="432"/>

<br/>


</p>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/15">
<h1>Our easiest wins are on the front end!</h1>

<ul>
<li>Server side <code>&lt;50%</code> of time</li>
<li>Usually <code>&lt;25%</code></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/16">
<h1>Front end 20%: Reverse Proxy</h1>

<ul>
<li>Lives in front of <code>uwsgi</code>/<code>mod_wsgi</code></li>
<li>Protects you from slow clients</li>
<li>Serves your media crazy-fast</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/17">
<h1>Front end 20%: GZIP</h1>

<ul>
<li>Tell nginx to GZIP everything</li>
<li>Remove django gzip middleware</li>
<li>Cut network transfer in half, for free</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content fullscreen center" ref="content/01_slide/18">
<p><img src="./file/content/fontawesome.png" width="744" height="674"/>

<br/>


</p>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/19">
<h1>Front end 20%: Use a font icon</h1>

<ul>
<li>HTTP requests for single icons slow you down</li>
<li>FontAwesome etc look better, anyway</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/20">
<h1>Front end 20%: Merged media</h1>

<ul>
<li>Use django-compressor (etc)</li>
<li>CSS at the top, JS at the bottom</li>
<li>Fewer HTTP requests win!</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content code fullscreen" ref="content/01_slide/21">
<pre><code># my_template.html

{% load compress %}

{% compress css %}
&lt;link rel="stylesheet"
    href="/static/css/one.css" type="text/css"&gt;
&lt;link rel="stylesheet"
    href="/static/css/two.css" type="text/css"&gt;
{% endcompress %}
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content fullscreen center" ref="content/01_slide/22">
<p><img src="./file/content/network_panel.png" width="1198" height="727"/></p>

<br/>


</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/23">
<h1>Anti-pattern 2: Database black box</h1></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/24">
<h1>Ways to kill your database</h1>

<ul>
<li>Don't use a cache or read slave</li>
<li>What's an index?</li>
<li>Who needs SQL?</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/25">
<h1>Database 20%: Memcached + Johnny-Cache</h1>

<ul>
<li>Dead-simple caching</li>
<li>Stale reads never hit your DB</li>
<li>Just works</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/26">
<pre><code># settings.py

MIDDLEWARE_CLASSES = (
    'johnny.middleware.LocalStoreClearMiddleware',
    'johnny.middleware.QueryCacheMiddleware',
    # ...
)
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/27">
<h1>Database 20%: Slow Query Log</h1>

<ul>
<li>Tells you when you're bad</li>
<li>Can still mostly use the ORM</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/28">
<h1>Enable the Slow Query Log</h1></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/29">
<pre><code># /etc/mysql/conf.d/slow_query.cnf

slow_query_log = 1
long_query_time = .1
log_queries_not_using_indexes = 1
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/30">
<h1>Read the Slow Query Log</h1></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/31">
<pre><code># Time: 130823 13:45:48
# User@Host: live0[live0] @ URL[IP]
# Query_time: 10.454075  Lock_time: 0.000085
    Rows_sent: 20  Rows_examined: 149654
use policystat;
SET timestamp=1377265548;
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/32">
<h1>How bad was it?</h1>

<pre><code># Query_time: 10.454075  Lock_time: 0.000085
    Rows_sent: 20  Rows_examined: 149654
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/33">
<h1>When was it?</h1>

<pre><code>SET timestamp=1377265548;
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/34">
<pre><code>SELECT `auth_user`.`id`, ...snip...
FROM `auth_user` LEFT OUTER JOIN `pstat_profile`
  ON (`auth_user`.`id` = `pstat_profile`.`user_id`)
  INNER JOIN `pstat_tenant`
    ON (`pstat_profile`.`tenant_id` = `pstat_tenant`.`id`)
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/35">
<pre><code>WHERE (`pstat_profile`.`is_guest` = 0
  AND `pstat_profile`.`tenant_id` IN (
    301, ...snip... 356)
  AND `auth_user`.`is_superuser` = 0
  AND `auth_user`.`is_active` = 1
)
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/36">
<h1>Where clause across tables</h1>

<ul>
<li>Can't index across tables with MySQL</li>
<li>Your DB chooses <em>one</em> index per table</li>
<li>A JOIN key counts as <em>one</em></li>
<li>Easy to filter superuser and inactive in python</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/37">
<pre><code>ORDER BY `auth_user`.`last_name` ASC,
`auth_user`.`first_name` ASC,
`auth_user`.`username` ASC
LIMIT 20;
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/38">
<h1>Complex <code>ORDER BY</code></h1>

<ul>
<li>No index there</li>
<li>Creates a temporary table!</li>
<li>Beware of default <code>order_by</code></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/39">
<h1>Database fixes</h1>

<ul>
<li>Add an index <code>tenant_id, is_guest</code></li>
<li>Python-side filtering <code>is_superuser, is_active</code></li>
<li>Sort on indexes <code>last_name, first_name, username</code></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/40">
<h1>Anti-pattern 3: Default Django Settings</h1></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/41">
<h1>Django Settings 20%: Cache Templates</h1>

<ul>
<li>Template evaluation is fast</li>
<li>Disk I/O can be slow</li>
<li>Cache templates in memory!</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/42">
<pre><code>TEMPLATE_LOADERS = (
(
  'django.template.loaders.cached.Loader',
  (
    'django.template.loaders.filesystem.Loader',
    'django.template.loaders.app_directories.Loader',
  )
),
)
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/43">
<h1>Anti-pattern 4: Query all the things!</h1></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/44">
<h1>Query 20%: Batch queries</h1>

<ul>
<li>Don't do queries when iterating in templates</li>
<li>Get things in one big query, where possible</li>
<li><code>select_related()</code> is usually your friend</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/45">
<pre><code># views.py

context = {
    'my_things': MyThing.objects.filter(foo=bar)
}

# my_template.html

&lt;table&gt;
{% for my_thing in my_things %}
    &lt;tr&gt;
        &lt;td&gt;{{ my_thing.name }}&lt;/td&gt;
        &lt;td&gt;{{ my_thing.other_thing.name }}&lt;/td&gt;
    &lt;tr&gt;
{% endfor %}
&lt;/table&gt;
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/46">
<h1>See the fail?</h1></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/47">
<pre><code># views.py

context = {
    'my_things': MyThing.objects.filter(
        foo=bar
    ).select_related('other_thing__name')
}
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content subsection" ref="content/01_slide/48">
<h1>Automate catching this fail!</h1></div>
</div><div class="slide" data-transition="none"><div class="content code" ref="content/01_slide/49">
<pre><code># views.py

def test_query_growth(self):
    expected_queries = FuzzyInteger(10, 13)

    # Make 5 MyThing objects

    with self.assertNumQueries(expected_queries):
        # Load the view

    # Make 5 more MyThing objects

    with self.assertNumQueries(expected_queries):
        # Load the view again
</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="content/01_slide/50">
<h1>Focus on the easy wins</h1>

<ul>
<li>No extra complexity</li>
<li>Make them a habit</li>
<li>The other 20% is much harder</li>
</ul>
</div>
</div></div>

</body>
</html>
